This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
tools/
  __init__.py
  payments.py
agent.py
config.json
control_tower.py
main.py
mylogger.py
runner.py
user_txt.txt
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="tools/__init__.py">
from .payments import tools, names_to_functions
</file>

<file path="tools/payments.py">
import json
import pandas as pd

data = {
    "transaction_id": ["T1001", "T1002", "T1003", "T1004", "T1005"],
    "customer_id": ["C001", "C002", "C003", "C002", "C001"],
    "payment_amount": [125.50, 89.99, 120.00, 54.30, 210.20],
    "payment_date": ["2021-10-05", "2021-10-06", "2021-10-07", "2021-10-05", "2021-10-08"],
    "payment_status": ["Paid", "Unpaid", "Paid", "Paid", "Pending"],
}

df = pd.DataFrame(data)

def retrieve_payment_status(transaction_id: str) -> str:
    if transaction_id in df.transaction_id.values:
        status = df[df.transaction_id == transaction_id].payment_status.item()
        return json.dumps({"status": status})
    return json.dumps({"error": "transaction id not found."})

def retrieve_payment_date(transaction_id: str) -> str:
    if transaction_id in df.transaction_id.values:
        date = df[df.transaction_id == transaction_id].payment_date.item()
        return json.dumps({"date": date})
    return json.dumps({"error": "transaction id not found."})

names_to_functions = {
    "retrieve_payment_status": retrieve_payment_status,
    "retrieve_payment_date": retrieve_payment_date,
}

tools = [
    {
        "type": "function",
        "function": {
            "name": "retrieve_payment_status",
            "description": "Get payment status of a transaction",
            "parameters": {
                "type": "object",
                "properties": {
                    "transaction_id": {"type": "string", "description": "The transaction id."}
                },
                "required": ["transaction_id"],
            },
        },
    },
    {
        "type": "function",
        "function": {
            "name": "retrieve_payment_date",
            "description": "Get payment date of a transaction",
            "parameters": {
                "type": "object",
                "properties": {
                    "transaction_id": {"type": "string", "description": "The transaction id."}
                },
                "required": ["transaction_id"],
            },
        },
    },
]
</file>

<file path="agent.py">
import os
import logging
from dotenv import load_dotenv
from mistralai import Mistral

load_dotenv()
log = logging.getLogger("app.agent")

class Agent:
    def __init__(self, tools, model: str = "ministral-3b-2512"):
        self.client = Mistral(api_key=os.environ["MISTRAL_API_KEY"])
        self.model = model
        self.tools = tools
        self.system_message = (
            "You are a helpful assistant that breaks down problems into steps and solves them systematically. "
            "Write max 3 sentences. "
            "Use tools only for payment transaction questions."
        )
        self.messages = [{"role": "system", "content": self.system_message}]
        self.turn_idx = 0

    def step(self):
        """
        One LLM step. Runner decides what to do with tool_calls.
        """
        response = self.client.chat.complete(
            model=self.model,
            messages=self.messages,
            tools=self.tools,
            tool_choice="auto",
            parallel_tool_calls=False,
            temperature=0.1,
            max_tokens=1024,
        )

        assistant_message = response.choices[0].message
        self.messages.append(assistant_message)
        return response
</file>

<file path="config.json">
{
  "version": 1,
  "disable_existing_loggers": false,

  "filters": {
    "non_error": { "()": "mylogger.NonErrorFilter" }
  },
  "loggers": {
    "httpcore": { "level": "WARNING", "propagate": true },
    "httpx": { "level": "WARNING", "propagate": true },
    "asyncio": { "level": "WARNING", "propagate": true }
  },
  "formatters": {
    "console": {
      "()": "mylogger.UTCISOFormatter",
      "format": "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
    },
    "json": {
      "()": "mylogger.MyJSONFormatter",
      "fmt_keys": {
        "level": "levelname",
        "logger": "name",
        "module": "module",
        "function": "funcName",
        "line": "lineno",
        "thread_name": "threadName"
      }
    }
  },

  "handlers": {
    "file_json": {
      "class": "logging.handlers.RotatingFileHandler",
      "level": "DEBUG",
      "formatter": "json",
      "filename": "logs/my_app.log.jsonl",
      "maxBytes": 1048576,
      "backupCount": 5,
      "encoding": "utf-8",
      "delay": true
    },

    "rerun": {
      "()": "rerun.LoggingHandler",
      "level": "DEBUG",
      "path_prefix": "logs/python"
    },

    "stderr": {
      "class": "logging.StreamHandler",
      "level": "WARNING",
      "formatter": "console",
      "stream": "ext://sys.stderr"
    },

    "stdout": {
      "class": "logging.StreamHandler",
      "level": "DEBUG",
      "formatter": "console",
      "filters": ["non_error"],
      "stream": "ext://sys.stdout"
    }
  },

  "root": {
    "level": "DEBUG",
    "handlers": ["stdout", "stderr", "file_json", "rerun"]
  }
}
</file>

<file path="control_tower.py">
import rerun as rr

_initialized = False


def init(app_id: str = "the_agent_logs", *, spawn: bool = True) -> None:
    global _initialized
    if _initialized:
        return
    rr.init(app_id, spawn=spawn)
    _initialized = True


def _set_time(turn_idx: int) -> None:
    rr.set_time("turn", sequence=turn_idx)


def on_turn(turn_idx: int, user_message: str) -> None:
    _set_time(turn_idx)
    rr.log(
        "agent/conversation",
        rr.TextLog(f"user: {user_message}", level=rr.TextLogLevel.INFO),
    )


def on_tool_call(turn_idx: int, function_name: str, function_params: dict) -> None:
    _set_time(turn_idx)
    rr.log(
        "agent/tool_calls",
        rr.TextLog(f"{function_name}({function_params})", level=rr.TextLogLevel.INFO),
    )


def on_assistant(turn_idx: int, content: str) -> None:
    _set_time(turn_idx)
    rr.log(
        "agent/conversation",
        rr.TextLog(f"assistant: {content}", level=rr.TextLogLevel.INFO),
    )


def on_usage(turn_idx: int, prompt_tokens: int, *, context_limit: int = 262_144) -> None:
    _set_time(turn_idx)

    rr.log("usage/prompt_tokens", rr.Scalars(prompt_tokens))

    fraction = min(prompt_tokens / context_limit, 1.0)
    base_radius = 10.2
    max_extra = 20.8
    radius = base_radius + max_extra * fraction

    if fraction < 0.5:
        color = [0, 255, 0]
    elif fraction < 0.8:
        color = [255, 200, 0]
    else:
        color = [255, 0, 0]

    rr.log("context/circle", rr.Points2D([[0.0, 2.0]], radii=[radius], colors=[color]))
</file>

<file path="main.py">
from agent import Agent
from runner import run_agent
from tools import tools
import logging
from pathlib import Path
from mylogger import setup_logging
import control_tower

BASE_DIR = Path(__file__).resolve().parent
teksten_path = BASE_DIR / "user_txt.txt"

# if I want to test ctx explosion..
with open(teksten_path, "r", encoding="utf-8") as file:
    prompt = file.read()


def main():
    control_tower.init()

    config_path = BASE_DIR / "config.json"
    setup_logging(str(config_path))

    log = logging.getLogger("app")
    agent = Agent(tools=tools)

    while True:
        run_agent(agent, "What is the payment status right now on the latest ID, which is T1001")
        run_agent(agent, "What is the payment status right now on the latest ID, which is T1001")
        run_agent(agent, "What is the payment status right now on the latest ID, which is T1001")
        run_agent(agent, "What is the payment status right now on the latest ID, which is T1001")
        run_agent(agent, prompt)
if __name__ == "__main__":
    main()
</file>

<file path="mylogger.py">
from __future__ import annotations

import datetime as dt
import json
import logging
import logging.config
from pathlib import Path
from typing import override


LOG_RECORD_BUILTIN_ATTRS = {
    "args", "asctime", "created", "exc_info", "exc_text", "filename", "funcName",
    "levelname", "levelno", "lineno", "module", "msecs", "message", "msg", "name",
    "pathname", "process", "processName", "relativeCreated", "stack_info",
    "thread", "threadName", "taskName",
}


class UTCISOFormatter(logging.Formatter):
    @override
    def formatTime(self, record: logging.LogRecord, datefmt=None) -> str:
        ts = dt.datetime.fromtimestamp(record.created, tz=dt.timezone.utc)
        return ts.isoformat(timespec="milliseconds").replace("+00:00", "Z")


class MyJSONFormatter(logging.Formatter):
    def __init__(self, *, fmt_keys: dict[str, str] | None = None):
        super().__init__()
        self.fmt_keys = fmt_keys or {}

    @override
    def format(self, record: logging.LogRecord) -> str:
        always: dict[str, object] = {
            "message": record.getMessage(),
            "timestamp": dt.datetime.fromtimestamp(
                record.created, tz=dt.timezone.utc
            ).isoformat(timespec="milliseconds").replace("+00:00", "Z"),
        }
        if record.exc_info:
            always["exc_info"] = self.formatException(record.exc_info)
        if record.stack_info:
            always["stack_info"] = self.formatStack(record.stack_info)

        out = {
            k: (always.pop(v, None) if v in always else getattr(record, v))
            for k, v in self.fmt_keys.items()
        }
        out.update(always)

        for k, v in record.__dict__.items():
            if k not in LOG_RECORD_BUILTIN_ATTRS:
                out[k] = v

        return json.dumps(out, ensure_ascii=False, default=str)


class NonErrorFilter(logging.Filter):
    @override
    def filter(self, record: logging.LogRecord) -> bool:
        return record.levelno <= logging.INFO


def setup_logging(config_path: str = "config.json") -> None:
    Path("logs").mkdir(parents=True, exist_ok=True)

    cfg = json.loads(Path(config_path).read_text(encoding="utf-8"))
    logging.config.dictConfig(cfg)
</file>

<file path="runner.py">
import json
import logging
from tools import names_to_functions
import control_tower as control_tower

log = logging.getLogger("app.runner")


def _prompt_tokens(response) -> int:
    return response.usage.prompt_tokens


def run_agent(agent, user_message: str, max_turns: int = 10):
    agent.messages.append({"role": "user", "content": user_message})

    agent.turn_idx += 1
    control_tower.on_turn(agent.turn_idx, user_message)

    prompt_tokens_max = 0

    response = agent.step()
    prompt_tokens_max = max(prompt_tokens_max, response.usage.prompt_tokens)


    assistant_message = response.choices[0].message

    turns = 0
    while getattr(assistant_message, "tool_calls", None):
        turns += 1
        if turns > max_turns:
            raise RuntimeError("Max turns reached without a final answer.")

        tool_call = assistant_message.tool_calls[0]
        function_name = tool_call.function.name
        function_params = json.loads(tool_call.function.arguments)

        control_tower.on_tool_call(agent.turn_idx, function_name, function_params)

        tool_function = names_to_functions.get(function_name)
        if tool_function is None:
            function_result = json.dumps({"error": f"Unknown tool: {function_name}"})
        else:
            function_result = tool_function(**function_params)

        agent.messages.append({
            "role": "tool",
            "tool_call_id": tool_call.id,
            "name": function_name,
            "content": function_result,
        })

        response = agent.step()
        
        prompt_tokens_max = max(prompt_tokens_max, response.usage.prompt_tokens)

        assistant_message = response.choices[0].message

    final_text = getattr(assistant_message, "content", "") or ""
    control_tower.on_assistant(agent.turn_idx, final_text)

    control_tower.on_usage(agent.turn_idx, prompt_tokens_max)



    return response
</file>

<file path="user_txt.txt">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec eget finibus est, non pulvinar orci. Phasellus dictum orci tellus, nec mollis arcu ornare ut. Etiam a risus convallis, mollis arcu nec, semper elit. Nullam dolor est, commodo in purus a, mollis aliquam nibh. Nullam id massa at velit varius varius. Maecenas vestibulum dictum vestibulum. Vestibulum sollicitudin et massa nec semper. Phasellus mollis lacus in orci gravida tristique.

Pellentesque lacus eros, mattis id volutpat porttitor, dignissim ac metus. Integer malesuada elit quam, sit amet pellentesque lorem mattis nec. Fusce tincidunt consectetur sem a lobortis. Curabitur pellentesque ligula eu varius efficitur. Nunc at turpis pretium, venenatis tellus sed, fermentum augue. Cras ac sodales augue. Donec ac tellus ac dui dictum lobortis vel id quam. Sed pretium et mauris non tempus. Nam vitae elit mauris. Fusce a sollicitudin leo. Curabitur sed lacus interdum, condimentum tortor vel, dapibus eros. Morbi at leo convallis, pulvinar ligula sit amet, tempor massa. Duis egestas ipsum nec ex ultricies consectetur. Ut eget eros quis dui condimentum tincidunt. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus.

Ut tincidunt rhoncus augue, id facilisis magna cursus nec. Integer egestas, lectus et lacinia euismod, sem mi feugiat justo, in luctus quam sapien et leo. Nulla sollicitudin id diam eget euismod. Proin non mi et magna laoreet elementum eget suscipit nisl. Nulla commodo mi sapien, ut aliquam arcu semper nec. Sed mattis porta lorem, ac molestie erat lacinia nec. Mauris ut gravida tortor. In sed purus accumsan ipsum rhoncus fermentum. Etiam non ex scelerisque, finibus diam et, ullamcorper lorem. Interdum et malesuada fames ac ante ipsum primis in faucibus. Phasellus pellentesque ligula commodo, elementum orci at, porta enim.

Proin id tellus eros. Maecenas vel vulputate enim. Sed eros ex, tristique ac feugiat non, tempor faucibus velit. Donec ultrices ipsum pulvinar, dapibus tellus non, cursus mi. Phasellus at turpis facilisis justo ornare malesuada id et erat. Proin tempor et velit eget aliquam. Quisque nec felis bibendum, iaculis dolor a, faucibus est. Maecenas vehicula elit at condimentum vestibulum. Proin a lobortis magna. Praesent ex massa, fringilla et elit a, fringilla sodales arcu. Pellentesque lobortis ipsum lacus, at pharetra orci hendrerit vitae. Suspendisse sed sem ut magna placerat condimentum. Vivamus congue ullamcorper ligula, id feugiat turpis sodales ut.

Maecenas ut suscipit felis. Nunc in malesuada ipsum. Sed quam nisl, porttitor eu quam id, gravida dictum ipsum. Quisque euismod convallis sodales. Integer posuere augue vel sapien fringilla tempus. Aenean malesuada dignissim felis, quis interdum enim maximus vitae. Mauris ac fringilla metus, ut dignissim lorem. Quisque efficitur consequat libero quis venenatis. Ut eu orci accumsan, tincidunt arcu at, sodales lorem. Sed posuere sem sed dui tincidunt mollis. Proin pharetra at tortor sit amet ultrices. Quisque turpis arcu, dapibus vitae hendrerit id, dapibus nec leo. Cras consectetur elementum erat. Morbi ut luctus orci. Proin eleifend justo a commodo bibendum. Lorem ipsum dolor sit amet, consectetur adipiscing elit.

Donec convallis eros vel porttitor pretium. Aliquam ultricies ligula sit amet efficitur laoreet. Curabitur rutrum velit tellus, et placerat mi tincidunt egestas. Phasellus mauris ex, euismod posuere mattis eget, rhoncus quis odio. Vivamus vitae consequat lectus. Vivamus sit amet dui lectus. Phasellus scelerisque congue eros, sed vestibulum magna. Nullam arcu diam, eleifend eget nisl in, dictum posuere justo.

Nunc eu facilisis augue. Vivamus pellentesque rhoncus vestibulum. In rhoncus eros eu erat ullamcorper ultricies. Fusce massa purus, laoreet vitae ligula congue, facilisis fringilla arcu. Sed a est gravida, finibus mi in, sagittis eros. Curabitur congue gravida erat in luctus. Maecenas leo dolor, pretium nec gravida at, lacinia eget eros. Donec porttitor pharetra molestie. Fusce orci odio, viverra blandit ipsum et, volutpat semper turpis. Proin faucibus nec dolor ut efficitur. Nullam ullamcorper facilisis odio, non mollis dui molestie sed. Vivamus congue condimentum felis, ac malesuada elit tempor non. Suspendisse auctor nibh risus, at lacinia metus tempus eu. Vestibulum finibus lorem orci, sed pellentesque neque tempor ac.

Nunc feugiat pulvinar massa, eget vestibulum turpis aliquet eu. Donec nisi erat, ornare non iaculis sed, varius id lectus. Etiam sit amet nibh id risus blandit imperdiet vitae vel ex. Sed ullamcorper dolor sed velit pretium, at pellentesque diam viverra. Aenean finibus, ipsum sed ultricies condimentum, ligula libero auctor augue, eu lobortis justo tortor ut turpis. Vivamus ac lectus scelerisque, pulvinar lorem eget, mattis eros. Curabitur pharetra enim in purus ultrices placerat. Donec lobortis vulputate leo id congue. Suspendisse tempus nibh eget dignissim luctus. Morbi aliquet felis id sem varius dignissim quis id nibh. Donec eu turpis nibh. Integer vehicula arcu tincidunt lectus volutpat, tempus aliquet erat pulvinar. Morbi elementum augue vitae dui sagittis euismod.

Suspendisse pellentesque fermentum diam. Donec sed ante eget nisl commodo rhoncus. Proin vulputate et mauris id ultrices. In hac habitasse platea dictumst. Nullam consequat magna et mauris fermentum, sed aliquet tellus sollicitudin. Proin finibus vehicula cursus. Cras tempus ac nulla ac placerat.

Pellentesque viverra dui porttitor convallis cursus. Sed sem ipsum, posuere a venenatis id, volutpat vel justo. Nulla ac tortor elit. Curabitur mollis condimentum eros eu eleifend. Nulla blandit ex ut tempus condimentum. Sed nibh lorem, commodo eu elit id, venenatis iaculis nisl. Phasellus pulvinar lobortis arcu, at consectetur quam malesuada ut. Aliquam a quam id nisl semper pharetra. Donec eget orci vel mauris hendrerit bibendum ac eu risus. Fusce id tellus sit amet diam tempus pellentesque. Duis sagittis mauris ut ex posuere lobortis. Etiam porttitor purus a fringilla sollicitudin. Pellentesque urna lacus, volutpat sed urna sed, volutpat dignissim tortor. Nunc efficitur dolor est, a fringilla orci semper sit amet.

In maximus ipsum enim, sit amet aliquet orci laoreet quis. Nam metus arcu, pellentesque in vestibulum at, malesuada accumsan lacus. Nam aliquet congue orci. Proin imperdiet, metus consequat commodo fringilla, diam augue vestibulum nisl, in semper mauris magna vitae libero. Pellentesque eu fermentum mi. Vestibulum turpis urna, aliquet sed nunc ut, porta bibendum justo. Donec volutpat ex id magna vulputate, vel luctus urna eleifend. Sed consequat convallis metus egestas maximus. Cras nulla lectus, maximus in fringilla in, finibus congue risus.

Maecenas maximus tristique tortor, a aliquet purus congue consequat. Ut tincidunt risus eu mollis ultrices. Cras ultrices placerat fermentum. Vestibulum eu lacinia est. Aliquam ultrices, massa id aliquet viverra, nulla erat sagittis ligula, non blandit justo sapien eu lorem. Nam porta consequat ante sit amet viverra. Maecenas pulvinar scelerisque dignissim. Fusce ut tempus neque, vitae gravida ligula. Proin congue venenatis turpis, vel viverra nisl ultricies sit amet. Pellentesque pretium non urna eu ornare. Fusce nisl risus, tincidunt vel lorem nec, mollis lobortis felis. Nunc feugiat accumsan semper. In cursus sem sed lacus hendrerit tincidunt. Donec tempor mi eget libero maximus blandit.

Nullam eu velit ac mauris tincidunt consectetur. Duis fermentum malesuada velit sed cursus. Vestibulum nec ligula sed turpis eleifend mattis. Suspendisse rutrum malesuada magna, sed faucibus tellus feugiat sit amet. Nunc aliquet augue at facilisis vehicula. Suspendisse ultricies ultricies hendrerit. Donec est mauris, commodo nec ultrices a, ornare et velit. Ut eget dolor gravida, porta leo ac, semper ante. Aliquam fermentum tortor nisi, ut congue purus dapibus accumsan.

Nulla scelerisque erat est, vitae lacinia ligula pulvinar nec. Nunc a efficitur enim. Suspendisse consectetur lacinia ultricies. Nam porta dictum mattis. Donec ut lorem sagittis, aliquam tortor a, finibus neque. Suspendisse lacus dolor, auctor vitae bibendum nec, accumsan id nisl. Etiam rhoncus vitae lectus ac semper. Donec iaculis neque non massa ultricies eleifend. Maecenas sit amet elit vitae leo pharetra vestibulum. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras interdum suscipit placerat. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Duis nec augue nisl. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae; Sed nec sollicitudin leo, quis pretium leo.

Maecenas vestibulum quis urna a lacinia. Maecenas vel commodo elit. Curabitur non eros in ipsum faucibus condimentum. Vivamus eget commodo dolor. Sed ipsum turpis, semper a ipsum in, condimentum pellentesque sapien. Duis consectetur lorem nec arcu tincidunt, et interdum ex imperdiet. Ut pellentesque quis eros ut maximus.

Donec porttitor feugiat arcu in volutpat. Curabitur malesuada tellus auctor feugiat posuere. Phasellus vitae interdum urna. Ut semper felis eget mauris imperdiet auctor. Curabitur placerat, erat in viverra tincidunt, nibh velit consequat justo, eu pellentesque purus ante eu ex. Nunc laoreet lacus vitae pharetra porttitor. Donec eget massa purus. In eu maximus metus. Pellentesque interdum, tortor vel vulputate ultricies, magna mi rutrum nunc, et sollicitudin odio erat vel nulla. Curabitur in ipsum in mauris accumsan cursus eget at felis. Donec vel nibh pulvinar, ultricies massa ut, dignissim mi. Nulla facilisi. Donec dolor leo, finibus at blandit vitae, facilisis nec justo. Duis vestibulum eleifend arcu sed commodo. Integer quis sodales quam. Quisque aliquet consequat sagittis.

Vestibulum accumsan consectetur lorem, sed suscipit velit scelerisque ut. Proin vehicula lectus eget lorem consectetur, nec consectetur ante consequat. Donec sit amet hendrerit lacus. Cras semper urna felis, id feugiat ante cursus et. Sed ullamcorper pretium metus, ac dictum ex egestas id. Nullam maximus tellus eu tortor finibus, quis suscipit nulla convallis. Nullam vitae quam sed ligula bibendum posuere. Phasellus magna turpis, fermentum in leo vel, ullamcorper euismod.
</file>

</files>
